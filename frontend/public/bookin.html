<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Booking | MindNest</title>
  <link rel="icon" type="image/png" href="./assets/img/mind.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root{
      --accent:#6c5ce7; --accent-2:#a29bfe;
      --bg: linear-gradient(180deg,#fbfbff 0%,#f2f7ff 100%);
      --card:#fff; --muted:#6b6b78; --radius:14px; --maxwidth:980px;
    }
    *{box-sizing:border-box}
    body{font-family:"Poppins",sans-serif;margin:0;background:var(--bg);color:#172033}
    .wrap{max-width:var(--maxwidth);margin:28px auto;padding:20px}
    .steps{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:20px;margin-top:36px}
    .step{flex:1;text-align:center;padding:10px;border-radius:10px;background:#fff;box-shadow:0 6px 18px rgba(20,20,50,0.04);color:var(--muted);font-weight:600;border:2px solid transparent}
    .step.active{color:var(--accent);border-color:var(--accent);box-shadow:0 10px 30px rgba(108,92,231,0.08)}
    .card{display:flex;gap:20px;background:var(--card);border-radius:var(--radius);padding:22px;box-shadow:0 18px 45px rgba(10,10,30,0.06)}
    .col-left{width:48%;min-width:300px}.col-right{flex:1;min-width:260px}
    .calendar{background:linear-gradient(180deg,#fff,#fff);border-radius:12px;padding:18px}
    .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .cal-nav button{background:transparent;border:0;font-size:18px;cursor:pointer;color:var(--accent)}
    .month-title{font-weight:700;color:#333}.weekdays{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-size:12px;color:var(--muted);margin-bottom:8px}
    .days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{height:54px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#333;background:transparent;border:1px solid transparent;transition:all .15s ease}
    .day:hover{transform:translateY(-4px);box-shadow:0 8px 18px rgba(16,24,40,0.04)}
    .day.other{opacity:0.25}.day.disabled{opacity:0.35;cursor:not-allowed}
    .day.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;box-shadow:0 8px 20px rgba(108,92,231,0.12)}
    .slots{margin-top:14px;display:flex;flex-wrap:wrap;gap:10px}
    .slot{padding:10px 12px;border-radius:10px;background:#f2f4ff;border:1px solid #edf0ff;cursor:pointer;font-weight:600;transition:all .12s}
    .slot:hover{transform:translateY(-3px)}
    .slot.selected{background:var(--accent);color:#fff;border-color:transparent;box-shadow:0 8px 20px rgba(108,92,231,0.08);transform:translateY(-4px)}
    .slot.disabled{background:#fff;color:#bbb;border:1px dashed #eee;cursor:not-allowed;transform:none;box-shadow:none}
    .panel{background:#fff;padding:18px;border-radius:12px;min-height:280px}
    .panel h3{margin:0 0 12px 0;color:#222}.field{margin-bottom:12px}
    input[type="text"],input[type="email"],input[type="tel"],input[type="number"],select{width:100%;padding:12px;border-radius:10px;border:1px solid #e6e6f2;outline:none}
    textarea{width:100%;padding:12px;border-radius:10px;min-height:90px;border:1px solid #e6e6f2}
    .btns{display:flex;gap:12px;margin-top:14px;align-items:center}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:10px 18px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.ghost{background:#f3f4fb;color:#444;box-shadow:none}
    .note{font-size:13px;color:var(--muted);margin-top:8px}
    .confirm-box{text-align:center;padding:20px}
    .booking-id{font-weight:800;color:var(--accent);font-size:20px;margin-top:10px}
    /* UPI Modal */
    #upiModal{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:9999}
    #upiModal .box{background:#fff; padding:18px; border-radius:12px; max-width:420px; width:92%; text-align:center;}
    #upiModal img{width:260px; height:260px; object-fit:contain; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.12);}
    /* responsive */
    @media(max-width:900px){.card{flex-direction:column}.col-left{width:100%}.col-right{width:100%}.steps{flex-direction:column;gap:10px}}
    @media(max-width:480px){
      .day{height:44px}
      #upiModal img{width:220px;height:220px}
      .wrap{padding:12px;margin:12px}
    }
    /* center alert (small) */
    .center-alert{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:14px 18px;border-radius:10px;box-shadow:0 12px 40px rgba(10,10,30,0.12);z-index:99999;display:none}
  </style>
</head>
<body>
  <div id="header"></div>

  <div class="wrap">
    <div class="steps">
      <div class="step active">1. Date & Time</div>
      <div class="step">2. Patient Info</div>
      <div class="step">3. Payment</div>
      <div class="step">4. Confirmation</div>
    </div>

    <div class="card">
      <!-- LEFT: calendar & slots -->
      <div class="col-left">
        <div class="calendar" id="calendarWrap">
          <div class="cal-head">
            <div class="month-title" id="monthTitle">Month</div>
            <div class="cal-nav">
              <button id="prevMonth">&lt;</button>
              <button id="nextMonth">&gt;</button>
            </div>
          </div>

          <div class="weekdays">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>

          <div class="days" id="daysGrid"></div>

          <div id="slotArea" style="margin-top:14px;">
            <div style="font-weight:700; margin-bottom:8px;" id="selectedDayTitle">Select a date to view slots</div>
            <div class="slots" id="slotsList"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: step content -->
      <div class="col-right">
        <!-- Step 1 -->
        <div class="panel" id="panel1">
          <h3>Step 1 — Pick date & slot</h3>
          <p class="note">Choose a date from the calendar and then pick an available time slot.</p>
          <div style="margin-top:18px;">
            <div><strong>Selected:</strong> <span id="selectedDisplay">None</span></div>
          </div>
          <div class="btns">
            <button class="btn ghost" id="clearSelection">Clear</button>
            <button class="btn" id="toInfo" disabled>Next: Patient Info</button>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="panel" id="panel2" style="display:none">
          <h3>Step 2 — Patient Information</h3>
          <div class="field"><input id="pname" type="text" placeholder="Full name"></div>
          <div class="field"><input id="page" type="number" placeholder="Age (years)"></div>
          <div class="field">
            <select id="ptype">
              <option value="General">General Counselling</option>
              <option value="Anxiety">Anxiety Support</option>
              <option value="Depression">Depression Counseling</option>
              <option value="Family">Family/Relationship</option>
            </select>
          </div>
          <div class="field"><input id="pmobile" type="tel" placeholder="Mobile"></div>
          <div class="field"><input id="pemail" type="email" placeholder="Email (optional)"></div>

          <div class="btns">
            <button class="btn ghost" id="backToStep1">Back</button>
            <button class="btn" id="toPayment">Next: Payment</button>
          </div>
        </div>

        <!-- Step 3 -->
        <div class="panel" id="panel3" style="display:none">
          <h3>Step 3 — Payment</h3>
          <p class="note">Choose payment method and complete payment to confirm booking.</p>
          <div class="field">
            <label><input type="radio" name="pay" value="upi" checked> UPI / PhonePe / GPay</label><br>
            <label><input type="radio" name="pay" value="card" disabled> Card (Coming soon)</label><br>
          </div>
          <div class="btns">
            <button class="btn ghost" id="backToStep2">Back</button>
            <button class="btn" id="payNow">Pay & Book</button>
          </div>
        </div>

        <!-- Step 4 -->
        <div class="panel" id="panel4" style="display:none">
          <h3>Step 4 — Confirmation</h3>
          <div class="confirm-box">
            <div>✅ Your booking is recorded</div>
            <div class="booking-id" id="bookingId">#BK0000</div>
            <div style="margin-top:12px;" id="confirmSummary"></div>
            <div style="margin-top:16px;"><button class="btn" id="finishBtn">Done</button></div>
            <p class="note" style="margin-top:10px;">Please complete the UPI payment from your app. Staff will verify and confirm your slot.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- UPI Modal (QR for desktop) -->
  <div id="upiModal">
    <div class="box">
      <h3 style="margin-top:0">Pay with UPI</h3>
      <p>Scan this QR from your UPI app (or click Open UPI App)</p>
      <img id="upiQr" src="" alt="UPI QR" />
      <div style="margin-top:12px; display:flex; gap:8px; justify-content:center;">
        <button id="openUpiBtn" class="btn">Open UPI App</button>
        <button id="closeUpiModal" class="btn ghost">Close</button>
      </div>
      <p style="font-size:13px; color:#666; margin-top:10px;">After payment, click <strong>I Have Paid</strong></p>
    </div>
  </div>

  <!-- small centered alert (for errors) -->
  <div class="center-alert" id="centerAlert">Error</div>

  <!-- (Razorpay script kept but unused) -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
  /* ================= CONFIG ================= */
  const SLOTS = ["09:00 AM","10:00 AM","11:30 AM","02:00 PM","03:30 PM","05:00 PM"];
  const API = 'https://mindnest-com.onrender.com'; // <-- change to your backend (http://localhost:4000) during local testing
  const UPI_ID = 'iyyappanmani1247@okaxis';
  const AMOUNT = 199; // INR amount

  /* ============ DOM Elements ============ */
  const daysGrid = document.getElementById('daysGrid');
  const slotsList = document.getElementById('slotsList');
  const monthTitle = document.getElementById('monthTitle');
  const selectedDisplay = document.getElementById('selectedDisplay');
  const selectedDayTitle = document.getElementById('selectedDayTitle');

  const upiModal = document.getElementById('upiModal');
  const upiQr = document.getElementById('upiQr');
  const openUpiBtn = document.getElementById('openUpiBtn');
  const closeUpiModal = document.getElementById('closeUpiModal');

  const centerAlert = document.getElementById('centerAlert');

  /* ============ STATE ============ */
  let today = new Date();
  let viewYear = today.getFullYear();
  let viewMonth = today.getMonth();
  let selectedDate = null;
  let selectedSlot = null;

  /* ============ Helpers ============ */
  function showCenterAlert(msg, timeout=2500){
    centerAlert.textContent = msg;
    centerAlert.style.display = 'block';
    setTimeout(()=> centerAlert.style.display = 'none', timeout);
  }

  function isMobile(){
    return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || (window.innerWidth <= 760);
  }

  function buildUpiLink(amount){
    const pa = encodeURIComponent(UPI_ID);
    const pn = encodeURIComponent('MindNest');
    const am = encodeURIComponent(amount);
    const tn = encodeURIComponent('MindNest Counselling Booking');
    return `upi://pay?pa=${pa}&pn=${pn}&am=${am}&cu=INR&tn=${tn}`;
  }

  function buildQrUrl(upiLink){
    return `https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=${encodeURIComponent(upiLink)}`;
  }

  /* ============ Calendar & slots ============ */
  function startOfMonth(y,m){ return new Date(y,m,1); }
  function daysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }

  async function renderCalendar(){
    daysGrid.innerHTML = '';
    monthTitle.textContent = new Intl.DateTimeFormat('en',{ month:'long', year:'numeric' })
                          .format(new Date(viewYear, viewMonth, 1));
    const firstDay = startOfMonth(viewYear,viewMonth).getDay();
    const totalDays = daysInMonth(viewYear,viewMonth);

    for(let i=0;i<firstDay;i++){
      const e = document.createElement('div'); e.className='day other'; daysGrid.appendChild(e);
    }

    for(let d=1; d<=totalDays; d++){
      const dt = new Date(viewYear, viewMonth, d);
      const iso = dt.toISOString().slice(0,10);
      const el = document.createElement('div'); el.className='day'; el.textContent = d;

      if(dt < new Date().setHours(0,0,0,0)){
        el.classList.add('disabled');
      }
      if(selectedDate === iso) el.classList.add('active');

      el.addEventListener('click', async ()=>{
        if(el.classList.contains('disabled')) return;
        selectedDate = iso;
        await renderCalendar();
        await renderSlotsForDate(iso);
        scrollToSlots();
      });

      daysGrid.appendChild(el);
    }
  }

  async function renderSlotsForDate(isoDate){
    slotsList.innerHTML = '';
    selectedSlot = null;
    selectedDisplay.textContent = 'None';
    selectedDayTitle.textContent = `Slots for ${isoDate}`;

    try{
      const r = await fetch(`${API}/api/booked-slots/${isoDate}`);
      if(!r.ok) { slotsList.innerHTML = '<div style="color:#c33">Error loading slots</div>'; return; }
      const data = await r.json();
      const booked = data.slots || [];

      SLOTS.forEach(slot=>{
        const b = document.createElement('button');
        b.className = 'slot';
        b.textContent = slot;

        if(booked.includes(slot)){
          b.classList.add('disabled'); b.disabled=true; b.title='Booked';
        } else {
          b.addEventListener('click', ()=>{
            document.querySelectorAll('.slot').forEach(x=>x.classList.remove('selected'));
            b.classList.add('selected');
            selectedSlot = slot;
            selectedDisplay.textContent = `${new Date(isoDate).toDateString()} • ${selectedSlot}`;
            document.getElementById('toInfo').disabled = false;
          });
        }
        slotsList.appendChild(b);
      });

    }catch(err){
      console.error(err);
      slotsList.innerHTML = '<div style="color:#c33">Error loading slots</div>';
    }
  }

  function scrollToSlots(){ document.getElementById('slotArea').scrollIntoView({behavior:'smooth', block:'center'}); }

  document.getElementById('prevMonth').addEventListener('click', ()=>{ viewMonth--; if(viewMonth<0){ viewMonth=11; viewYear--; } renderCalendar(); });
  document.getElementById('nextMonth').addEventListener('click', ()=>{ viewMonth++; if(viewMonth>11){ viewMonth=0; viewYear++; } renderCalendar(); });

  /* ============ Steps control ============ */
  const stepEls = document.querySelectorAll('.step');
  function setStep(n){
    stepEls.forEach((s,i)=> s.classList.toggle('active', i===n-1));
    document.getElementById('panel1').style.display = (n===1?'block':'none');
    document.getElementById('panel2').style.display = (n===2?'block':'none');
    document.getElementById('panel3').style.display = (n===3?'block':'none');
    document.getElementById('panel4').style.display = (n===4?'block':'none');
  }

  document.getElementById('toInfo').addEventListener('click', ()=>{ if(!selectedDate||!selectedSlot) return alert('Select date and slot first'); setStep(2); });
  document.getElementById('backToStep1').addEventListener('click', ()=> setStep(1));
  document.getElementById('toPayment').addEventListener('click', ()=> {
    const name = document.getElementById('pname').value.trim();
    const mobile = document.getElementById('pmobile').value.trim();
    if(!name) return alert('Enter name');
    if(!mobile) return alert('Enter mobile');
    setStep(3);
  });
  document.getElementById('backToStep2').addEventListener('click', ()=> setStep(2));

  /* clear */
  document.getElementById('clearSelection').addEventListener('click', ()=>{
    selectedDate=null; selectedSlot=null; selectedDisplay.textContent='None';
    document.getElementById('toInfo').disabled=true;
    renderCalendar(); slotsList.innerHTML=''; selectedDayTitle.textContent='Select a date to view slots';
  });

  /* ============ Payment (UPI) flow ============ */
  function showUpiModal(amount){
    const link = buildUpiLink(amount);
    upiQr.src = buildQrUrl(link);
    upiModal.style.display = 'flex';
    openUpiBtn.onclick = ()=> { window.location.href = link; };
    closeUpiModal.onclick = ()=> { upiModal.style.display = 'none'; };
  }

  function buildUpiLink(amount){
    const pa = encodeURIComponent(UPI_ID);
    const pn = encodeURIComponent('MindNest');
    const am = encodeURIComponent(amount);
    const tn = encodeURIComponent('MindNest Counselling Booking');
    return `upi://pay?pa=${pa}&pn=${pn}&am=${am}&cu=INR&tn=${tn}`;
  }
  function buildQrUrl(upiLink){
    return `https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=${encodeURIComponent(upiLink)}`;
  }

  document.getElementById('payNow').addEventListener('click', async ()=>{
    if(!selectedDate || !selectedSlot) return alert('Select date & slot first');

    const name = document.getElementById('pname').value.trim();
    const mobile = document.getElementById('pmobile').value.trim();
    const email = document.getElementById('pemail').value.trim();
    const type = document.getElementById('ptype').value;
    const amount = AMOUNT;

    if(!name || !mobile){ alert('Enter name & mobile'); setStep(2); return; }

    // mobile -> deep link, desktop -> QR modal
    if(isMobile()){
      window.location.href = buildUpiLink(amount);
    } else {
      showUpiModal(amount);
    }

    // Replace payment UI with Confirm buttons so user confirms after paying
    const panel3 = document.getElementById('panel3');
    panel3.innerHTML = `
      <h3>Complete Payment</h3>
      <p class="note">Complete the payment in your UPI app. After successful payment click the button below.</p>
      <div style="display:flex;gap:10px;margin-top:12px;">
        <button class="btn" id="confirmPaid">I Have Paid</button>
        <button class="btn ghost" id="retryPay">Retry Payment</button>
      </div>
    `;

    document.getElementById('retryPay').onclick = ()=>{
      // reopen modal or mobile link
      if(isMobile()) window.location.href = buildUpiLink(amount);
      else showUpiModal(amount);
    };

    // attach handler for confirm
    setTimeout(()=> {
      const confirmBtn = document.getElementById('confirmPaid');
      if(!confirmBtn) return;
      confirmBtn.onclick = async ()=>{
        // call backend to save booking as paid
        const payload = { date: selectedDate, slot: selectedSlot, name, mobile, email, amountINR: amount, type, upi: UPI_ID };
        try{
          const res = await fetch(`${API}/api/confirm-upi`, {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify(payload)
          });
          if(!res.ok){
            const txt = await res.text();
            console.error('confirm-upi failed', txt);
            showCenterAlert('Booking save failed. Contact support.');
            return;
          }
          const json = await res.json();
          const bid = json.bookingId || ('BK' + Date.now().toString().slice(-6));
          document.getElementById('bookingId').textContent = bid;
          document.getElementById('confirmSummary').innerHTML = `
            <div><strong>${name}</strong></div>
            <div>${new Date(selectedDate).toDateString()} • ${selectedSlot}</div>
            <div>Type: ${type}</div>
            <div>Contact: ${mobile}</div>
          `;
          setStep(4);
          upiModal.style.display = 'none';
          // backend may return whatsapp links for user/doctor; you can open them here if needed (optional)
          if(json.userWhatsApp) window.open(json.userWhatsApp,'_blank');
        }catch(err){
          console.error(err);
          showCenterAlert('Network error — booking not saved.');
        }
      };
    }, 100);
  });

  /* finish */
  document.getElementById('finishBtn').addEventListener('click', ()=>{
    selectedDate=null; selectedSlot=null;
    document.getElementById('pname').value=''; document.getElementById('page').value=''; document.getElementById('pmobile').value=''; document.getElementById('pemail').value='';
    document.getElementById('toInfo').disabled = true;
    setStep(1); renderCalendar(); slotsList.innerHTML='';
  });

  /* initial */
  document.getElementById('toInfo').disabled = true;
  renderCalendar();

  /* ============ Notes: commented Razorpay code kept for later ============ */
  /*
  // OLD Razorpay flow (kept for future)
  // const r = await fetch(`${API}/api/create-order`, { method:'POST', body: JSON.stringify({ amountINR:199, date:selectedDate, slot:selectedSlot, name, mobile, email }) });
  // const order = await r.json();
  // var options = { key: 'RAZORPAY_KEY', amount: order.amount, order_id: order.id, handler: function(response){ ... } };
  // var rzp = new Razorpay(options); rzp.open();
  */
  </script>

  <div id="footer"></div>
</body>
</html>
