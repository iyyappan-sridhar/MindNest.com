<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Booking | MindNest</title>
  <link rel="icon" type="image/png" href="./assets/img/mind.png">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/css/header.css">
  <link rel="stylesheet" href="./assets/css/footer.css">
  <link rel="stylesheet" href="./assets/css/chatbot.css">
  <link rel="stylesheet" href="./assets/css/booking.css">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  
</head>
<body>
  <div id="header"></div>
  <div id="chatbotContainer"></div>

  <div class="wrap">
    <div class="steps">
      <div class="step active">1. Date & Time</div>
      <div class="step">2. Patient Info</div>
      <div class="step">3. Payment</div>
      <div class="step">4. Confirmation</div>
    </div>

    <div class="card">

      <!-- LEFT: calendar & slots -->
      <div class="col-left">
        <div class="calendar" id="calendarWrap">
          <div class="cal-head">
            <div class="month-title" id="monthTitle">Month</div>
            <div class="cal-nav">
              <button id="prevMonth">&lt;</button>
              <button id="nextMonth">&gt;</button>
            </div>
          </div>

          <div class="weekdays">
            <div>Sun</div><div>Mon</div><div>Tue</div>
            <div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>

          <div class="days" id="daysGrid"></div>

          <div id="slotArea" style="margin-top:14px;">
            <div style="font-weight:700; margin-bottom:8px;"
                 id="selectedDayTitle">Select a date to view slots</div>
            <div class="slots" id="slotsList"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: step content -->
      <div class="col-right">
        <!-- STEP 1 -->
        <div class="panel" id="panel1">
          <h3>Step 1 â€” Pick date & slot</h3>
          <p class="note">Choose a date from the calendar and then pick an available time slot.</p>
          <div style="margin-top:18px;">
            <div><strong>Selected:</strong> <span id="selectedDisplay">None</span></div>
          </div>
          <div class="btns">
            <button class="btn ghost" id="clearSelection">Clear</button>
            <button class="btn" id="toInfo" disabled>Next: Patient Info</button>
          </div>
        </div>

        <!-- STEP 2 -->
        <div class="panel" id="panel2" style="display:none">
          <h3>Step 2 â€” Patient Information</h3>
          <div class="field">
            <input id="pname" type="text" placeholder="Full name">
          </div>
          <div class="field">
            <input id="page" type="number" placeholder="Age (years)">
          </div>
          <div class="field">
            <select id="ptype">
              <option value="General">General Counselling</option>
              <option value="Anxiety">Anxiety Support</option>
              <option value="Depression">Depression Counseling</option>
              <option value="Family">Family/Relationship</option>
            </select>
          </div>
          <div class="field">
            <input id="pmobile" type="tel" placeholder="Mobile">
          </div>
          <div class="field">
            <input id="pemail" type="email" placeholder="Email (optional)">
          </div>

          <div class="btns">
            <button class="btn ghost" id="backToStep1">Back</button>
            <button class="btn" id="toPayment">Next: Payment</button>
          </div>
        </div>

        <!-- STEP 3 -->
        <div class="panel" id="panel3" style="display:none">
          <h3>Step 3 â€” Payment</h3>
          <p class="note">Choose payment method and complete payment to confirm booking.</p>

          <div class="field">
            <label><input type="radio" name="pay" value="upi" checked> UPI / PhonePe / GPay</label><br>
            <label><input type="radio" name="pay" value="card" disabled> Card (Coming soon)</label><br>
          </div>

          <div class="btns">
            <button class="btn ghost" id="backToStep2">Back</button>
            <button class="btn" id="payNow">Pay & Book</button>
          </div>
        </div>

        <!-- STEP 4 -->
        <div class="panel" id="panel4" style="display:none">
          <h3>Step 4 â€” Confirmation</h3>
          <div class="confirm-box">
            <div>âœ… Your booking is recorded</div>
            <div class="booking-id" id="bookingId">#BK0000</div>
            <div style="margin-top:12px;" id="confirmSummary"></div>
            <div style="margin-top:16px;">
              <button class="btn" id="finishBtn">Done</button>
            </div>
            <p class="note" style="margin-top:10px;">
              Please complete the UPI payment from your app. Our team will verify and confirm your slot.
            </p>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Razorpay script kept (not used now, just in case future) -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

 <script>
/* ========================== CONFIG =========================== */
const SLOTS = ["09:00 AM","10:00 AM","11:30 AM","02:00 PM","03:30 PM","05:00 PM"];
const API   = "https://mindnest-com.onrender.com";   // backend URL
const UPI_ID = "iyyappanmani1247@okaxis";
const AMOUNT = 1;

/* ================= VARIABLES ================= */
let today = new Date();
let viewYear = today.getFullYear();
let viewMonth = today.getMonth();
let selectedDate = null;
let selectedSlot = null;

/* ================= GET ELEMENTS ================= */
const daysGrid        = document.getElementById("daysGrid");
const slotsList       = document.getElementById("slotsList");
const monthTitle      = document.getElementById("monthTitle");
const selectedDisplay = document.getElementById("selectedDisplay");
const selectedDayTitle= document.getElementById("selectedDayTitle");

/* ================= CALENDAR ================= */
function startOfMonth(y,m){ return new Date(y,m,1); }
function daysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }

async function renderCalendar(){
    daysGrid.innerHTML="";
    monthTitle.textContent = new Intl.DateTimeFormat("en",{month:"long",year:"numeric"})
                           .format(new Date(viewYear,viewMonth,1));

    const firstDay     = startOfMonth(viewYear,viewMonth).getDay();
    const totalDays    = daysInMonth(viewYear,viewMonth);

    for(let i=0;i<firstDay;i++){
        let e=document.createElement("div");
        e.className="day other";
        daysGrid.appendChild(e);
    }

    for(let d=1;d<=totalDays;d++){
        const dt=new Date(viewYear,viewMonth,d);
        const iso = dt.toISOString().slice(0,10);
        let el=document.createElement("div");
        el.className="day";
        el.textContent=d;

        if(dt<new Date().setHours(0,0,0,0)){
           el.classList.add("disabled");
        }
        if(selectedDate===iso) el.classList.add("active");

        el.onclick=async()=>{
           if(el.classList.contains("disabled"))return;
           selectedDate=iso;
           renderCalendar();
           renderSlots(iso);
        };
        daysGrid.appendChild(el);
    }
}

async function renderSlots(date){
    slotsList.innerHTML="";
    selectedSlot=null;
    selectedDisplay.textContent="None";
    selectedDayTitle.textContent=`Slots for ${date}`;

    try{
       const r=await fetch(`${API}/api/booked-slots/${date}`);
       const booked=(await r.json()).slots || [];

       SLOTS.forEach(slot=>{
         let b=document.createElement("button");
         b.className="slot";
         b.textContent=slot;

         if(booked.includes(slot)){
            b.disabled=true; b.classList.add("disabled");
         }else{
            b.onclick=()=>{
                document.querySelectorAll(".slot").forEach(x=>x.classList.remove("selected"));
                b.classList.add("selected");
                selectedSlot=slot;

                /* â˜… FIXED: live display update */
                selectedDisplay.textContent = `${formatDate(date)} â€¢ ${slot}`;
                document.getElementById("toInfo").disabled=false;
            };
         }
         slotsList.appendChild(b);
       });

    }catch(e){console.log(e);slotsList.innerHTML="<p>Error loading slots</p>";}
}

/* convert ISO date */
function formatDate(d){ return new Date(d).toDateString(); }

/* scroll slot area */
function scrollToSlots(){ document.getElementById("slotArea").scrollIntoView({behavior:"smooth"}); }

/* month navigation */
document.getElementById("prevMonth").onclick=()=>{viewMonth--; if(viewMonth<0){viewMonth=11;viewYear--;};renderCalendar();};
document.getElementById("nextMonth").onclick=()=>{viewMonth++; if(viewMonth>11){viewMonth=0;viewYear++;};renderCalendar();};

renderCalendar();

/* ================= STEPS ================= */
const steps=document.querySelectorAll(".step");
function setStep(n){steps.forEach((s,i)=>s.classList.toggle("active",i===n-1));
["panel1","panel2","panel3","panel4"].forEach((id,i)=>document.getElementById(id).style.display=(i===n-1?"block":"none"));
}

/* step buttons */
document.getElementById("toInfo").onclick=()=>{if(!selectedDate||!selectedSlot)return; setStep(2);}
document.getElementById("backToStep1").onclick=()=>setStep(1);
document.getElementById("toPayment").onclick=()=>{
    let n=pname.value.trim(), m=pmobile.value.trim();
    if(!n || !m) return alert("Enter name & mobile");
    setStep(3);
};
document.getElementById("backToStep2").onclick=()=>setStep(2);

/* ===================== UPI PAYMENT ===================== */
document.getElementById('payNow').addEventListener('click', ()=>{

    if(!selectedDate || !selectedSlot) return alert("Select date & slot first");

    const amountINR = 199;
    const name  = document.getElementById('pname').value.trim();
    const mobile = document.getElementById('pmobile').value.trim();
    const email = document.getElementById('pemail').value.trim();
    const type  = document.getElementById('ptype').value;

    if(!name || !mobile){
        alert("Enter name & mobile");
        return setActiveStep(2);
    }

    // ðŸ”¹ Only open upi â€“ don't save booking yet!
    const upiURL = `upi://pay?pa=iyyappanmani1247@okaxis&pn=MindNest&am=${amountINR}&cu=INR&tn=MindNest Booking`;
    window.location.href = upiURL;

    // ðŸ”¹ Show new button to confirm payment later
    document.getElementById("panel3").innerHTML = `
        <h3>Complete Payment</h3>
        <p class="note">Please complete payment in UPI app.</p>
        <button class="btn" id="confirmPaid">I Have Paid</button>
        <button class="btn ghost" id="backToStep2">Back</button>
    `;

    // After payment done manually user clicks confirm
    setTimeout(()=>{
        document.getElementById("confirmPaid").onclick = async ()=>{

            const payload = {amountINR,date:selectedDate,slot:selectedSlot,name,mobile,email,type,upi:"iyyappanmani1247@okaxis",paid:true};

            const res = await fetch(`${API}/api/confirm-upi`,{
                method:"POST",
                headers:{ "Content-Type":"application/json"},
                body: JSON.stringify(payload)
            });

            if(!res.ok) return alert("Booking not saved, contact support");

            const bid = "BK" + Date.now().toString().slice(-6);
            document.getElementById("bookingId").textContent = bid;

            document.getElementById("confirmSummary").innerHTML = `
                <div><strong>${name}</strong></div>
                <div>${isoToReadable(selectedDate)} â€¢ ${selectedSlot}</div>
                <div>Type: ${type}</div>
                <div>Contact: ${mobile}</div>
            `;

            setActiveStep(4);
        };
    },800);
});

/* finish reset */
document.getElementById("finishBtn").onclick=()=>{
  selectedDate=null; selectedSlot=null;
  pname.value=""; pemail.value=""; pmobile.value="";
  document.getElementById("toInfo").disabled=true;
  setStep(1); renderCalendar();
};

document.getElementById("toInfo").disabled=true;

/* clear */
document.getElementById("clearSelection").onclick=()=>{
  selectedDate=null; selectedSlot=null;
  selectedDisplay.textContent="None";
  document.getElementById("toInfo").disabled=true;
  renderCalendar(); slotsList.innerHTML="";
  selectedDayTitle.textContent="Select a date to view slots";
};
</script>


  <div id="footer"></div>

  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script src="./assets/js/main.js"></script>
  <script src="./assets/js/header.js"></script>
  <script src="./assets/js/chatbot.js"></script>
</body>
</html>
