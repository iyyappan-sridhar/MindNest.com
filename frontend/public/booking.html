<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Booking | MindNest</title>
   <link rel="icon" type="image/png" href="./assets/img/mind.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/css/header.css">
  <link rel="stylesheet" href="./assets/css/footer.css">
  <style>
    :root{--accent:#d633ff;--accent-2:#ff7ab6;--bg:#fbfbff;--card:#ffffff;--muted:#7a7a8a;--radius:16px;--maxwidth:980px}
    *{box-sizing:border-box}
    body{font-family:"Poppins",sans-serif;margin:0;background:linear-gradient(180deg,#fbfbff 0%,#f2f7ff 100%);color:#222}
    .wrap{max-width:var(--maxwidth);margin:28px auto;padding:20px}
    .steps{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:20px; margin-top: 90px;}  
    .step{flex:1;text-align:center;padding:12px 8px;border-radius:10px;background:#fff;box-shadow:0 6px 18px rgba(20,20,50,0.06);color:var(--muted);font-weight:600;border:2px solid transparent}
    .step.active{color:var(--accent);border-color:var(--accent);box-shadow:0 10px 30px rgba(214,51,255,0.08)}
    .card{display:flex;gap:20px;background:var(--card);border-radius:var(--radius);padding:22px;box-shadow:0 18px 45px rgba(10,10,30,0.06)}
    .col-left{width:48%;min-width:300px}.col-right{flex:1;min-width:260px}.calendar{background:linear-gradient(180deg,#fff,#fff);border-radius:12px;padding:18px}
    .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .cal-nav button{background:transparent;border:0;font-size:18px;cursor:pointer;color:var(--accent)}
    .month-title{font-weight:700;color:#333}.weekdays{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-size:12px;color:var(--muted);margin-bottom:8px}
    .days{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}.day{height:54px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#333;background:transparent;border:1px solid transparent}
    .day.other{opacity:0.25}.day.disabled{opacity:0.35;cursor:not-allowed}.day.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;box-shadow:0 8px 20px rgba(214,51,255,0.12)}
    .slots{margin-top:14px;display:flex;flex-wrap:wrap;gap:10px}.slot{padding:10px 12px;border-radius:10px;background:#f2f4ff;border:1px solid #edf0ff;cursor:pointer;font-weight:600}
    .slot.selected{background:var(--accent);color:#fff;border-color:transparent;box-shadow:0 8px 20px rgba(214,51,255,0.08);transform:translateY(-4px)}
    .slot.disabled{background:#fff;color:#bbb;border:1px dashed #eee;cursor:not-allowed;transform:none;box-shadow:none}.panel{background:#fff;padding:18px;border-radius:12px;min-height:360px}
    .panel h3{margin:0 0 12px 0;color:#222}.field{margin-bottom:12px}
    input[type="text"],input[type="email"],input[type="tel"],input[type="number"],select{width:100%;padding:12px;border-radius:10px;border:1px solid #e6e6f2;outline:none}
    textarea{width:100%;padding:12px;border-radius:10px;min-height:90px;border:1px solid #e6e6f2}
    .btns{display:flex;gap:12px;margin-top:14px;align-items:center}
    .btn{background:var(--accent);color:#fff;padding:10px 18px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.ghost{background:#f3f4fb;color:#444;box-shadow:none}.note{font-size:13px;color:var(--muted);margin-top:8px}
    .confirm-box{text-align:center;padding:25px}
    .booking-id{font-weight:800;color:var(--accent);font-size:20px;margin-top:10px}
    @media(max-width:900px){.card{flex-direction:column}.col-left{width:100%}.col-right{width:100%}.steps{flex-direction:column;gap:10px}}
  </style>
</head>
<body>
  <div id="header"></div>

<div class="wrap">
  <div class="steps">
    <div class="step active">1. Date & Time</div>
    <div class="step">2. Patient Info</div>
    <div class="step">3. Payment</div>
    <div class="step">4. Confirmation</div>
  </div>

  <div class="card">

    <!-- LEFT: calendar & slots -->
    <div class="col-left">
      <div class="calendar" id="calendarWrap">
        <div class="cal-head">
          <div class="month-title" id="monthTitle">Month</div>
          <div class="cal-nav">
            <button id="prevMonth">&lt;</button>
            <button id="nextMonth">&gt;</button>
          </div>
        </div>

        <div class="weekdays">
          <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        </div>

        <div class="days" id="daysGrid"></div>

        <div id="slotArea" style="margin-top:14px;">
          <div style="font-weight:700; margin-bottom:8px;" id="selectedDayTitle">Select a date to view slots</div>
          <div class="slots" id="slotsList"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: step content -->
    <div class="col-right">
      <div class="panel" id="panel1">
        <h3>Step 1 — Pick date & slot</h3>
        <p class="note">Choose a date from the calendar and then pick an available time slot.</p>
        <div style="margin-top:18px;">
          <div><strong>Selected:</strong> <span id="selectedDisplay">None</span></div>
        </div>
        <div class="btns">
          <button class="btn ghost" id="clearSelection">Clear</button>
          <button class="btn" id="toInfo" disabled>Next: Patient Info</button>
        </div>
      </div>

      <div class="panel" id="panel2" style="display:none">
        <h3>Step 2 — Patient Information</h3>
        <div class="field"><input id="pname" type="text" placeholder="Full name"></div>
        <div class="field">
          <input id="page" type="number" placeholder="Age (years)">
        </div>
        <div class="field">
          <select id="ptype">
            <option value="General">General Counselling</option>
            <option value="Anxiety">Anxiety Support</option>
            <option value="Depression">Depression Counseling</option>
            <option value="Family">Family/Relationship</option>
          </select>
        </div>
        <div class="field"><input id="pmobile" type="tel" placeholder="Mobile"></div>
        <div class="field"><input id="pemail" type="email" placeholder="Email (optional)"></div>

        <div class="btns">
          <button class="btn ghost" id="backToStep1">Back</button>
          <button class="btn" id="toPayment">Next: Payment</button>
        </div>
      </div>

      <div class="panel" id="panel3" style="display:none">
        <h3>Step 3 — Payment</h3>
        <p class="note">Choose payment method and complete payment to confirm booking.</p>

        <div class="field">
          <label><input type="radio" name="pay" value="upi" checked> UPI / PhonePe / GPay</label><br>
          <label><input type="radio" name="pay" value="card"> Card</label><br>
          <label><input type="radio" name="pay" value="cash"> Pay After Consultation</label>
        </div>

        <div class="btns">
          <button class="btn ghost" id="backToStep2">Back</button>
          <button class="btn" id="payNow">Pay & Book</button>
        </div>
      </div>

      <div class="panel" id="panel4" style="display:none">
        <h3>Step 4 — Confirmation</h3>
        <div class="confirm-box">
          <div>✅ Your booking is confirmed</div>
          <div class="booking-id" id="bookingId">#BK0000</div>
          <div style="margin-top:12px;" id="confirmSummary"></div>
          <div style="margin-top:16px;"><button class="btn" id="finishBtn">Done</button></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Razorpay Checkout -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
/* ========== CONFIG ========== */
const SLOTS = ["09:00 AM","10:00 AM","11:30 AM","02:00 PM","03:30 PM","05:00 PM"];
const API = 'https://mindnest-com.onrender.com'; // backend url - change if needed

let today = new Date();
let viewYear = today.getFullYear();
let viewMonth = today.getMonth();
let selectedDate = null;
let selectedSlot = null;

const daysGrid = document.getElementById('daysGrid');
const monthTitle = document.getElementById('monthTitle');
const prevMonthBtn = document.getElementById('prevMonth');
const nextMonthBtn = document.getElementById('nextMonth');
const slotsList = document.getElementById('slotsList');
const selectedDisplay = document.getElementById('selectedDisplay');
const selectedDayTitle = document.getElementById('selectedDayTitle');

function startOfMonth(year,m){ return new Date(year,m,1); }
function daysInMonth(year,m){ return new Date(year,m+1,0).getDate(); }

async function renderCalendar(){
  daysGrid.innerHTML='';
  monthTitle.textContent = new Intl.DateTimeFormat('en',{ month:'long', year:'numeric'}).format(new Date(viewYear,viewMonth,1));

  const firstDay = startOfMonth(viewYear,viewMonth);
  const startWeekday = firstDay.getDay();
  const totalDays = daysInMonth(viewYear,viewMonth);

  for(let i=0;i<startWeekday;i++){ const d=document.createElement('div'); d.className='day other'; d.innerHTML=''; daysGrid.appendChild(d); }

  for(let date=1; date<=totalDays; date++){
    const dt = new Date(viewYear, viewMonth, date);
    const dayEl = document.createElement('div'); dayEl.className='day';
    const todayOnly = new Date(); todayOnly.setHours(0,0,0,0);
    if(dt < todayOnly){ dayEl.classList.add('disabled'); dayEl.textContent = date; daysGrid.appendChild(dayEl); continue; }

    dayEl.textContent = date;
    const iso = dt.toISOString().slice(0,10);
    if(selectedDate === iso) dayEl.classList.add('active');

    dayEl.addEventListener('click', async ()=>{
      if(dayEl.classList.contains('disabled')) return;
      selectedDate = dt.toISOString().slice(0,10);
      await renderCalendar();
      await renderSlotsForDate(selectedDate);
      scrollToSlots();
    });

    daysGrid.appendChild(dayEl);
  }
}

// fetch booked slots from backend
async function renderSlotsForDate(isoDate){
  slotsList.innerHTML=''; selectedSlot=null; selectedDisplay.textContent='None'; selectedDayTitle.textContent = `Slots for ${isoDate}`;
  try{
    const r = await fetch(`${API}/api/booked-slots/${isoDate}`);
    const data = await r.json();
    const bookedForDate = data.slots || [];

    SLOTS.forEach(slot=>{
      const b = document.createElement('button'); b.className='slot'; b.textContent=slot;
      if(bookedForDate.includes(slot)){ b.classList.add('disabled'); b.disabled=true; b.title='Booked'; }
      else { b.addEventListener('click', ()=>{ document.querySelectorAll('.slot').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); selectedSlot=slot; selectedDisplay.textContent = isoToReadable(selectedDate) + ' • ' + selectedSlot; document.getElementById('toInfo').disabled=false; }); }
      slotsList.appendChild(b);
    });
  }catch(e){ console.error(e); slotsList.innerHTML = '<div style="color:#c33">Error loading slots</div>' }
}

function isoToReadable(iso){ const d=new Date(iso); return d.toDateString(); }
function scrollToSlots(){ document.getElementById('slotArea').scrollIntoView({behavior:'smooth', block:'center'}); }

prevMonthBtn.addEventListener('click', ()=>{ viewMonth--; if(viewMonth<0){ viewMonth=11; viewYear--; } renderCalendar(); });
nextMonthBtn.addEventListener('click', ()=>{ viewMonth++; if(viewMonth>11){ viewMonth=0; viewYear++; } renderCalendar(); });

renderCalendar();

document.getElementById('clearSelection').addEventListener('click', ()=>{ selectedDate=null; selectedSlot=null; document.getElementById('toInfo').disabled=true; selectedDisplay.textContent='None'; renderCalendar(); slotsList.innerHTML=''; selectedDayTitle.textContent='Select a date to view slots'; });

const stepEls = document.querySelectorAll('.step');
function setActiveStep(n){ stepEls.forEach((s,i)=> s.classList.toggle('active', i===n-1)); document.getElementById('panel1').style.display=(n===1?'block':'none'); document.getElementById('panel2').style.display=(n===2?'block':'none'); document.getElementById('panel3').style.display=(n===3?'block':'none'); document.getElementById('panel4').style.display=(n===4?'block':'none'); }

document.getElementById('toInfo').addEventListener('click', ()=>{ if(!selectedDate||!selectedSlot) return alert('Select date and slot first'); setActiveStep(2); });
document.getElementById('backToStep1').addEventListener('click', ()=> setActiveStep(1));
document.getElementById('toPayment').addEventListener('click', ()=>{ const name=document.getElementById('pname').value.trim(); const mobile=document.getElementById('pmobile').value.trim(); if(!name) return alert('Enter name'); if(!mobile) return alert('Enter mobile'); setActiveStep(3); });
document.getElementById('backToStep2').addEventListener('click', ()=> setActiveStep(2));

/* Razorpay flow */
document.getElementById('payNow').addEventListener('click', async ()=>{
  if(!selectedDate||!selectedSlot) return alert('Select date and slot first');

  const payload = {
    amountINR: 199,
    date: selectedDate,
    slot: selectedSlot,
    name: document.getElementById('pname').value.trim(),
    mobile: document.getElementById('pmobile').value.trim(),
    email: document.getElementById('pemail').value.trim()
  };

  try{
    const createRes = await fetch(`${API}/api/create-order`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const createJson = await createRes.json();
    if(!createRes.ok){ alert(createJson.error || 'Could not create order'); return; }

    const order = createJson.order;
    const options = {
      key: 'REPLACE_WITH_YOUR_KEY_ID',
      amount: order.amount,
      currency: order.currency,
      name: 'Medical Counselling',
      description: 'Appointment fees',
      order_id: order.id,
      handler: async function(response){
        // verify on server
        const verifyRes = await fetch(`${API}/api/verify-payment`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ razorpay_order_id: response.razorpay_order_id, razorpay_payment_id: response.razorpay_payment_id, razorpay_signature: response.razorpay_signature }) });
        const verifyJson = await verifyRes.json();
        if(!verifyRes.ok){ alert(verifyJson.error || 'Verification failed'); return; }

        // show confirmation
        const bid = 'BK' + Date.now().toString().slice(-6);
        document.getElementById('bookingId').textContent = bid;
        document.getElementById('confirmSummary').innerHTML = `<div><strong>${payload.name}</strong></div><div>${isoToReadable(payload.date)} • ${payload.slot}</div><div>Contact: ${payload.mobile}</div>`;
        setActiveStep(4);
        renderCalendar();
        renderSlotsForDate(selectedDate);
      },
      modal: { ondismiss: function(){ alert('Payment cancelled'); } }
    };

    const rzp = new Razorpay(options);
    rzp.open();

  }catch(e){ console.error(e); alert('Payment flow error'); }
});

// finish
document.getElementById('finishBtn').addEventListener('click', ()=>{ selectedDate=null; selectedSlot=null; document.getElementById('pname').value=''; document.getElementById('page').value=''; document.getElementById('pmobile').value=''; document.getElementById('pemail').value=''; document.getElementById('toInfo').disabled=true; setActiveStep(1); renderCalendar(); });

// disable next initially
document.getElementById('toInfo').disabled = true;

</script>

<div id="footer"></div>
<script src="./assets/js/main.js"> </script>
<script src="./assets/js/header.js"></script>
</body>
</html>
